#!/usr/bin/ruby

require 'digest/md5'

ROOT_PATH="<%= @deploy[:deploy_to] %>"
APP_NAME="<%= @application %>"
PID_PATH="/mnt/srv/www/<%= @application %>/shared/pids/unicorn.pid"
OLD_PID_PATH="/mnt/srv/www/<%= @application %>/shared/pids/unicorn.pid.oldbin"

def run_and_print_command(command)
  puts command
  system(command) || exit(1)
end

def run_and_ignore_exitcode_and_print_command(command)
  puts command
  system(command)
end

def pid_file_exists?
  File.exists?(PID_PATH)
end

def old_pid_file_exists?
  File.exists?(OLD_PID_PATH)
end

def process_id
  File.read(PID_PATH).chomp
rescue Errno::ENOENT
  nil
end

def old_process_id
  File.read(OLD_PID_PATH).chomp
rescue Errno::ENOENT
  nil
end

def unicorn_restarting?
  old_pid_file_exists? && process_running?(old_process_id)
end

def process_running? process_id
  system("ps aux | grep #{process_id} | grep -v grep > /dev/null")
end

def unicorn_running?
  pid_file_exists? && process_running?(process_id)
end

def different_gemfile?
  if File.exists?("#{ROOT_PATH}/current/Gemfile")
    dir = Dir["#{ROOT_PATH}/releases/*"]
    previous_release_path = dir.sort[dir.size-2]
    if !previous_release_path.nil? && File.exists?("#{previous_release_path}/Gemfile")
      return Digest::MD5.hexdigest(File.read("#{ROOT_PATH}/current/Gemfile")) != Digest::MD5.hexdigest(File.read("#{previous_release_path}/Gemfile"))
    end
  end
  false
end

def start_unicorn
  if File.exists?("#{ROOT_PATH}/current/Gemfile")
    puts "OpsWorks: Gemfile detected - running Unicorn with bundle exec"
    run_and_ignore_exitcode_and_print_command "cd #{ROOT_PATH}/current && /usr/local/bin/bundle exec unicorn_rails --env <%= @deploy[:rails_env] %> --daemonize -c #{ROOT_PATH}/shared/config/unicorn.conf"
  else
    puts "OpsWorks: no Gemfile detected - running plain Unicorn"
    run_and_ignore_exitcode_and_print_command "cd #{ROOT_PATH}/current && unicorn_rails --env <%= @deploy[:rails_env] %> --daemonize -c #{ROOT_PATH}/shared/config/unicorn.conf"
  end
end

def stop_unicorn
  if unicorn_running?
    if run_and_ignore_exitcode_and_print_command "kill -QUIT #{process_id}"
      `rm #{PID_PATH}`
    end
  else
    puts "You can't stop unicorn, because it's not running"
  end
end

def restart_unicorn
  if unicorn_running?
    run_and_ignore_exitcode_and_print_command "kill -USR2 #{process_id}"
  else
    start_unicorn
  end
end

def reload_config
  if unicorn_running?
    run_and_ignore_exitcode_and_print_command "kill -HUP #{process_id}"
  else
    puts "Unicorn is not currently running"
  end
end

def clean_restart
  if different_gemfile?
    puts "Found a previous version with a different Gemfile: Doing a stop & start"
    stop_unicorn if unicorn_running?
    start_unicorn
  else
    puts "No previous version with a different Gemfile found. Assuming a quick restart without re-loading gems is save"
    restart_unicorn
  end
end

def status_unicorn
  if pid = unicorn_running?
    puts "Unicorn flightbookings running with PID #{pid}"
    return true
  else
    puts "Unicorn flightbookings not running"
    return false
  end
end

def perform_if_not_restarting command
  unless unicorn_restarting?
    send(command)
  else
    puts "Refusing to run command #{command} because Unicorn is restarting (old_pid: #{old_process_id})"
    exit 1
  end
end


case ARGV[0]
when "start"
  puts "Starting Unicorn #{APP_NAME}"
  perform_if_not_restarting(:start_unicorn)
when "stop"
  puts "Stopping Unicorn #{APP_NAME}"
  perform_if_not_restarting(:stop_unicorn)
when "status"
  status_unicorn
when "restart"
  perform_if_not_restarting(:restart_unicorn)
when "clean-restart"
  perform_if_not_restarting(:clean_restart)
when "reload"
  perform_if_not_restarting(:reload_config)
else
  puts "Usage: {start|stop|status|restart|clean-restart}"
  exit 1
end

exit 0
